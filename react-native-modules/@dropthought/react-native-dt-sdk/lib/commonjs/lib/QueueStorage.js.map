{"version":3,"names":["_Storage","require","_encryptedStorage","_interopRequireDefault","_ramda","obj","__esModule","default","waitUntil","check","round","Promise","resolve","timeout","setTimeout","QueueStorage","constructor","key","storageKey","queue","initialized","syncToStorage","encryptedStorage","setItemT","err","console","log","migration","queuedElements","loadData","length","removeData","initialize","undefined","getItemT","concat","clear","getAll","front","head","enqueue","element","Array","isArray","append","dequeue","firstElement","tail","exports","_default"],"sources":["QueueStorage.js"],"sourcesContent":["/**\n * @description simple queue operation, and sync to async storage with designated key\n */\nimport { loadData, removeData } from './Storage';\nimport encryptedStorage from './encrypted-storage';\nimport { head, tail, append } from 'ramda';\n\n/**\n * @param {() => boolean} check\n * @returns\n */\nconst waitUntil = async (check) => {\n  let round = 0;\n  return new Promise((resolve) => {\n    const timeout = () => {\n      round++;\n      setTimeout(() => {\n        if (check() || round >= 20) {\n          resolve();\n          return;\n        } else {\n          timeout();\n        }\n      }, 300);\n    };\n    timeout();\n  });\n};\n\n/**\n * @example\n *     const basicTextQueue = new QueueStorage({ key: 'Storage-basic-text'})\n *     basicTextQueue.enqueue('a')  // queue: ['a']\n *     basicTextQueue.front() // => 'a'\n *     basicTextQueue.enqueue('b') // queue: ['a', 'b']\n *     basicTextQueue.enqueue(['c', 'd']) // queue: ['a', 'b', 'c', 'd']\n *     basicTextQueue.front() // => 'a'\n *\n *     basicTextQueue.dequeue()  // queue: ['b', 'c', 'd']\n *     basicTextQueue.front() // => 'b'\n * @template T\n */\nexport class QueueStorage {\n  constructor({ key }) {\n    /** @type {string} */\n    this.storageKey = key;\n    /** @type {T[]} */\n    this.queue = [];\n\n    /** @type {boolean | null | undefined} */\n    this.initialized = null; // null -> not start yet, undefined -> in progress, true -> finished\n  }\n\n  /**\n   * @private\n   */\n  async syncToStorage() {\n    if (this.initialized === null) return;\n    if (typeof this.initialized === 'undefined') {\n      await waitUntil(() => this.initialized === true);\n    }\n\n    try {\n      await encryptedStorage.setItemT(this.storageKey, this.queue);\n    } catch (err) {\n      console.log('##### syncToStorage error, err', err);\n    }\n  }\n\n  /**\n   * @private\n   */\n  async migration() {\n    const queuedElements = await loadData(this.storageKey);\n    if (!queuedElements || !queuedElements.length) {\n      // console.log('### no data in', this.storageKey)\n      return;\n    }\n    await encryptedStorage.setItemT(this.storageKey, queuedElements);\n    await removeData(this.storageKey);\n  }\n\n  /**\n   * @public\n   */\n  async initialize() {\n    // only initialize once\n    if (this.initialized === true) return;\n    if (typeof this.initialized === 'undefined') {\n      return waitUntil(() => this.initialized === true);\n    }\n    this.initialized = undefined;\n\n    await this.migration();\n\n    const queuedElements = await encryptedStorage.getItemT(this.storageKey, []);\n\n    this.queue = queuedElements.concat(this.queue);\n    this.initialized = true;\n    await this.syncToStorage();\n  }\n\n  async clear() {\n    this.queue = [];\n    await this.syncToStorage();\n  }\n\n  /**\n   * @returns {T[]}\n   */\n  getAll() {\n    return this.queue;\n  }\n\n  /**\n   * get the first element of the queue\n   * @returns {T|undefined}\n   */\n  front() {\n    return head(this.queue);\n  }\n\n  /**\n   * adding element(s) to the back of the queue\n   * @param {T|[T]} element\n   */\n  enqueue(element) {\n    // if element is an array, use array concat, otherwise, use append\n    if (Array.isArray(element)) {\n      this.queue = this.queue.concat(element);\n    } else {\n      this.queue = append(element, this.queue);\n    }\n    this.syncToStorage();\n  }\n\n  /**\n   * remove an element from the front of the queue\n   * @returns {T|undefined}\n   */\n  dequeue() {\n    const firstElement = head(this.queue);\n    this.queue = tail(this.queue);\n    this.syncToStorage();\n    return firstElement;\n  }\n}\n\nexport default QueueStorage;\n"],"mappings":";;;;;;AAGA,IAAAA,QAAA,GAAAC,OAAA;AACA,IAAAC,iBAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,MAAA,GAAAH,OAAA;AAA2C,SAAAE,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAL3C;AACA;AACA;;AAKA;AACA;AACA;AACA;AACA,MAAMG,SAAS,GAAG,MAAOC,KAAK,IAAK;EACjC,IAAIC,KAAK,GAAG,CAAC;EACb,OAAO,IAAIC,OAAO,CAAEC,OAAO,IAAK;IAC9B,MAAMC,OAAO,GAAGA,CAAA,KAAM;MACpBH,KAAK,EAAE;MACPI,UAAU,CAAC,MAAM;QACf,IAAIL,KAAK,CAAC,CAAC,IAAIC,KAAK,IAAI,EAAE,EAAE;UAC1BE,OAAO,CAAC,CAAC;UACT;QACF,CAAC,MAAM;UACLC,OAAO,CAAC,CAAC;QACX;MACF,CAAC,EAAE,GAAG,CAAC;IACT,CAAC;IACDA,OAAO,CAAC,CAAC;EACX,CAAC,CAAC;AACJ,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAME,YAAY,CAAC;EACxBC,WAAWA,CAAC;IAAEC;EAAI,CAAC,EAAE;IACnB;IACA,IAAI,CAACC,UAAU,GAAGD,GAAG;IACrB;IACA,IAAI,CAACE,KAAK,GAAG,EAAE;;IAEf;IACA,IAAI,CAACC,WAAW,GAAG,IAAI,CAAC,CAAC;EAC3B;;EAEA;AACF;AACA;EACE,MAAMC,aAAaA,CAAA,EAAG;IACpB,IAAI,IAAI,CAACD,WAAW,KAAK,IAAI,EAAE;IAC/B,IAAI,OAAO,IAAI,CAACA,WAAW,KAAK,WAAW,EAAE;MAC3C,MAAMZ,SAAS,CAAC,MAAM,IAAI,CAACY,WAAW,KAAK,IAAI,CAAC;IAClD;IAEA,IAAI;MACF,MAAME,yBAAgB,CAACC,QAAQ,CAAC,IAAI,CAACL,UAAU,EAAE,IAAI,CAACC,KAAK,CAAC;IAC9D,CAAC,CAAC,OAAOK,GAAG,EAAE;MACZC,OAAO,CAACC,GAAG,CAAC,gCAAgC,EAAEF,GAAG,CAAC;IACpD;EACF;;EAEA;AACF;AACA;EACE,MAAMG,SAASA,CAAA,EAAG;IAChB,MAAMC,cAAc,GAAG,MAAM,IAAAC,iBAAQ,EAAC,IAAI,CAACX,UAAU,CAAC;IACtD,IAAI,CAACU,cAAc,IAAI,CAACA,cAAc,CAACE,MAAM,EAAE;MAC7C;MACA;IACF;IACA,MAAMR,yBAAgB,CAACC,QAAQ,CAAC,IAAI,CAACL,UAAU,EAAEU,cAAc,CAAC;IAChE,MAAM,IAAAG,mBAAU,EAAC,IAAI,CAACb,UAAU,CAAC;EACnC;;EAEA;AACF;AACA;EACE,MAAMc,UAAUA,CAAA,EAAG;IACjB;IACA,IAAI,IAAI,CAACZ,WAAW,KAAK,IAAI,EAAE;IAC/B,IAAI,OAAO,IAAI,CAACA,WAAW,KAAK,WAAW,EAAE;MAC3C,OAAOZ,SAAS,CAAC,MAAM,IAAI,CAACY,WAAW,KAAK,IAAI,CAAC;IACnD;IACA,IAAI,CAACA,WAAW,GAAGa,SAAS;IAE5B,MAAM,IAAI,CAACN,SAAS,CAAC,CAAC;IAEtB,MAAMC,cAAc,GAAG,MAAMN,yBAAgB,CAACY,QAAQ,CAAC,IAAI,CAAChB,UAAU,EAAE,EAAE,CAAC;IAE3E,IAAI,CAACC,KAAK,GAAGS,cAAc,CAACO,MAAM,CAAC,IAAI,CAAChB,KAAK,CAAC;IAC9C,IAAI,CAACC,WAAW,GAAG,IAAI;IACvB,MAAM,IAAI,CAACC,aAAa,CAAC,CAAC;EAC5B;EAEA,MAAMe,KAAKA,CAAA,EAAG;IACZ,IAAI,CAACjB,KAAK,GAAG,EAAE;IACf,MAAM,IAAI,CAACE,aAAa,CAAC,CAAC;EAC5B;;EAEA;AACF;AACA;EACEgB,MAAMA,CAAA,EAAG;IACP,OAAO,IAAI,CAAClB,KAAK;EACnB;;EAEA;AACF;AACA;AACA;EACEmB,KAAKA,CAAA,EAAG;IACN,OAAO,IAAAC,WAAI,EAAC,IAAI,CAACpB,KAAK,CAAC;EACzB;;EAEA;AACF;AACA;AACA;EACEqB,OAAOA,CAACC,OAAO,EAAE;IACf;IACA,IAAIC,KAAK,CAACC,OAAO,CAACF,OAAO,CAAC,EAAE;MAC1B,IAAI,CAACtB,KAAK,GAAG,IAAI,CAACA,KAAK,CAACgB,MAAM,CAACM,OAAO,CAAC;IACzC,CAAC,MAAM;MACL,IAAI,CAACtB,KAAK,GAAG,IAAAyB,aAAM,EAACH,OAAO,EAAE,IAAI,CAACtB,KAAK,CAAC;IAC1C;IACA,IAAI,CAACE,aAAa,CAAC,CAAC;EACtB;;EAEA;AACF;AACA;AACA;EACEwB,OAAOA,CAAA,EAAG;IACR,MAAMC,YAAY,GAAG,IAAAP,WAAI,EAAC,IAAI,CAACpB,KAAK,CAAC;IACrC,IAAI,CAACA,KAAK,GAAG,IAAA4B,WAAI,EAAC,IAAI,CAAC5B,KAAK,CAAC;IAC7B,IAAI,CAACE,aAAa,CAAC,CAAC;IACpB,OAAOyB,YAAY;EACrB;AACF;AAACE,OAAA,CAAAjC,YAAA,GAAAA,YAAA;AAAA,IAAAkC,QAAA,GAAAD,OAAA,CAAAzC,OAAA,GAEcQ,YAAY"}