{"version":3,"names":["loadData","removeData","encryptedStorage","head","tail","append","waitUntil","check","round","Promise","resolve","timeout","setTimeout","QueueStorage","constructor","key","storageKey","queue","initialized","syncToStorage","setItemT","err","console","log","migration","queuedElements","length","initialize","undefined","getItemT","concat","clear","getAll","front","enqueue","element","Array","isArray","dequeue","firstElement"],"sources":["QueueStorage.js"],"sourcesContent":["/**\n * @description simple queue operation, and sync to async storage with designated key\n */\nimport { loadData, removeData } from './Storage';\nimport encryptedStorage from './encrypted-storage';\nimport { head, tail, append } from 'ramda';\n\n/**\n * @param {() => boolean} check\n * @returns\n */\nconst waitUntil = async (check) => {\n  let round = 0;\n  return new Promise((resolve) => {\n    const timeout = () => {\n      round++;\n      setTimeout(() => {\n        if (check() || round >= 20) {\n          resolve();\n          return;\n        } else {\n          timeout();\n        }\n      }, 300);\n    };\n    timeout();\n  });\n};\n\n/**\n * @example\n *     const basicTextQueue = new QueueStorage({ key: 'Storage-basic-text'})\n *     basicTextQueue.enqueue('a')  // queue: ['a']\n *     basicTextQueue.front() // => 'a'\n *     basicTextQueue.enqueue('b') // queue: ['a', 'b']\n *     basicTextQueue.enqueue(['c', 'd']) // queue: ['a', 'b', 'c', 'd']\n *     basicTextQueue.front() // => 'a'\n *\n *     basicTextQueue.dequeue()  // queue: ['b', 'c', 'd']\n *     basicTextQueue.front() // => 'b'\n * @template T\n */\nexport class QueueStorage {\n  constructor({ key }) {\n    /** @type {string} */\n    this.storageKey = key;\n    /** @type {T[]} */\n    this.queue = [];\n\n    /** @type {boolean | null | undefined} */\n    this.initialized = null; // null -> not start yet, undefined -> in progress, true -> finished\n  }\n\n  /**\n   * @private\n   */\n  async syncToStorage() {\n    if (this.initialized === null) return;\n    if (typeof this.initialized === 'undefined') {\n      await waitUntil(() => this.initialized === true);\n    }\n\n    try {\n      await encryptedStorage.setItemT(this.storageKey, this.queue);\n    } catch (err) {\n      console.log('##### syncToStorage error, err', err);\n    }\n  }\n\n  /**\n   * @private\n   */\n  async migration() {\n    const queuedElements = await loadData(this.storageKey);\n    if (!queuedElements || !queuedElements.length) {\n      // console.log('### no data in', this.storageKey)\n      return;\n    }\n    await encryptedStorage.setItemT(this.storageKey, queuedElements);\n    await removeData(this.storageKey);\n  }\n\n  /**\n   * @public\n   */\n  async initialize() {\n    // only initialize once\n    if (this.initialized === true) return;\n    if (typeof this.initialized === 'undefined') {\n      return waitUntil(() => this.initialized === true);\n    }\n    this.initialized = undefined;\n\n    await this.migration();\n\n    const queuedElements = await encryptedStorage.getItemT(this.storageKey, []);\n\n    this.queue = queuedElements.concat(this.queue);\n    this.initialized = true;\n    await this.syncToStorage();\n  }\n\n  async clear() {\n    this.queue = [];\n    await this.syncToStorage();\n  }\n\n  /**\n   * @returns {T[]}\n   */\n  getAll() {\n    return this.queue;\n  }\n\n  /**\n   * get the first element of the queue\n   * @returns {T|undefined}\n   */\n  front() {\n    return head(this.queue);\n  }\n\n  /**\n   * adding element(s) to the back of the queue\n   * @param {T|[T]} element\n   */\n  enqueue(element) {\n    // if element is an array, use array concat, otherwise, use append\n    if (Array.isArray(element)) {\n      this.queue = this.queue.concat(element);\n    } else {\n      this.queue = append(element, this.queue);\n    }\n    this.syncToStorage();\n  }\n\n  /**\n   * remove an element from the front of the queue\n   * @returns {T|undefined}\n   */\n  dequeue() {\n    const firstElement = head(this.queue);\n    this.queue = tail(this.queue);\n    this.syncToStorage();\n    return firstElement;\n  }\n}\n\nexport default QueueStorage;\n"],"mappings":"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"}